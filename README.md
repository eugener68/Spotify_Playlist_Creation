# Spotify Playlist Creation

Automate playlist creation for Spotify based on artist lists or your library/followed artists.

## Required Spotify scopes

The app needs the following scopes when you authenticate with Spotify:

- `playlist-modify-private`
- `playlist-modify-public`
- `user-top-read`
- `user-follow-read`

Set the `SPOTIFY_SCOPES` environment variable to the comma-separated list above (or leave it unset to use the defaults). After changing scopes, sign out in the app and sign back in so Spotify issues a token with the new permissions.

## Packaging

### Windows & macOS executables (PyInstaller)

This repository now ships with platform-specific PyInstaller specs and helper scripts that bundle the Kivy UI and default configuration automatically.

1. **Install build dependencies** inside a fresh virtual environment:

   ```bash
   python -m pip install -r requirements.txt
   python -m pip install pyinstaller
   ```

2. **Run the platform-specific helper script** from the project root:

   - **Windows (PowerShell):**

     ```powershell
     ./scripts/build-windows.ps1
     ```

     Pass `-Clean` to force a fresh build (`./scripts/build-windows.ps1 -Clean`).

      Uses `packaging/AutoPlaylistBuilder.spec`, which produces the standard folder-style distribution expected on Windows.

   - **macOS (zsh/bash):** run the script on a Mac host with a working Python 3 + Kivy toolchain (you can make it executable once via `chmod +x scripts/build-macos.sh`):

     ```bash
     ./scripts/build-macos.sh
     ```

      Add `--clean` to force a fresh build, or point to a different interpreter with `--python /full/path/to/python`. Any other arguments are passed straight to PyInstaller. Append `--bundle-env` to tuck the project `.env` into `AutoPlaylistBuilder.app/Contents/Resources/.env` for self-contained distribution. This script targets `packaging/AutoPlaylistBuilder-mac.spec`, which emits a true `.app` bundle with GUI-only boot mode.

   Both scripts include `app/ui/main.kv` and `config/settings.py`, and request the correct SDL/GLEW backends for each OS.

3. **Distribute the bundle** located in `dist/AutoPlaylistBuilder/`. On Windows, copy your `.env` alongside the executable (or adjust baked defaults in `config/settings.py`). On macOS, pass `--bundle-env` during the build or manually add the file inside the generated `.app` under `Contents/Resources/.env`.
4. **Optional macOS signing:** For public releases, sign and notarise the app (`codesign --deep --force --sign ...` followed by `xcrun notarytool submit`). Skip this step for personal testing.

### Android APK (Buildozer)
Below are opinionated, reproducible steps for turning this Kivy app into an installable Android APK (and optionally an AAB for Play Store) on a Linux host. You already have a Buildozer environment; still, skim the prerequisites to ensure parity.

> Note: `buildozer.spec` is intentionally **not tracked** in this repository to keep packaging configuration local and avoid accidental commits of signing config. Generate your own each time (or keep a private copy) with `buildozer init`, then edit per the table below. If you prefer a reusable template, copy it to `buildozer.spec.local` and add that filename to your personal global gitignore.

Quick recreate if you deleted yours:
```bash
rm -f buildozer.spec
buildozer init
# Then edit fields: title, package.name, package.domain, version, requirements, android.permissions, android.archs
```

#### 0. High‑level Overview
You will:
1. Install system packages & create a Python venv.
2. Install Buildozer + Cython inside that venv.
3. Adjust `buildozer.spec` to reflect this project (title, package id, requirements, permissions, assets).
4. Provide Spotify credentials (env vars at build time or baked defaults).
5. Build a debug APK and deploy to a connected device.
6. (Optional) Create a signed release (APK or AAB) for distribution.

#### 1. System Prerequisites (Ubuntu/Debian example)
```bash
sudo apt update
sudo apt install -y python3 python3-venv python3-pip \
  openjdk-17-jdk unzip git build-essential libssl-dev \
  libffi-dev libsqlite3-dev zlib1g-dev
```
OpenJDK 17 is recommended (avoid JDK 21 for now unless you pin recent p4a/Gradle). If you previously installed conflicting JDKs, ensure `java -version` reports 17.

#### 2. Create / Activate a Virtual Environment
```bash
python3 -m venv buildozer-env
source buildozer-env/bin/activate
python -m pip install --upgrade pip
python -m pip install cython buildozer
```
If your existing `buildozer-env` already contains these, just `source buildozer-env/bin/activate`.

#### 3. Review & Edit `buildozer.spec`
This repo already has a `buildozer.spec` generated by `buildozer init`. Update these key entries under `[app]`:

| Setting | Suggested Value | Why |
|---------|-----------------|-----|
| title | Spotify Playlist Creator | Human‑readable app name |
| package.name | autoplaylistbuilder | Java/Kotlin style last component |
| package.domain | com.eugener68 | Reverse DNS domain you control (adjust) |
| version | 0.1.0 | Semantic version (match desktop release) |
| source.dir | . | Root already correct |
| source.include_exts | py,kv,png,jpg,atlas | Ensure `.kv` is packaged |
| requirements | python3,kivy,requests,httpx,python-dotenv | Mirrors `requirements.txt` |
| orientation | portrait | UI is portrait-oriented |
| android.permissions | android.permission.INTERNET | Needed for Spotify API |
| android.archs | arm64-v8a, armeabi-v7a | Ship 32/64‑bit (Play needs 64‑bit) |
| fullscreen | 0 | Keep status bar (optional) |

Additional optional tweaks:
* Uncomment and set an icon: `icon.filename = %(source.dir)s/path/to/icon.png` (adaptive icons: foreground/background for API 26+).
* If you want auto license acceptance during CI: set `android.accept_sdk_license = True` (in `[app]` section; Buildozer merges it appropriately).
* To produce an AAB for Play Store later: add `android.release_artifact = aab` (you can switch temporarily for release builds).

##### Requirements Notes
Avoid listing every transitive dependency—`requests` and `httpx` pull in their own pure-Python deps which p4a handles. If something fails to import at runtime, append it later. Keep `python3` first, then core libs.

##### Environment / Secrets Strategy
Do NOT hardcode your Spotify client secret in version control. Recommended approaches:
1. Export vars before build (simplest):
   ```bash
   export SPOTIFY_CLIENT_ID=your_id
   export SPOTIFY_CLIENT_SECRET=your_secret
   export SPOTIFY_REDIRECT_URI=your.scheme://callback
   buildozer -v android debug
   ```
   Access inside Python with `os.environ.get("SPOTIFY_CLIENT_ID")`.
2. Bundle a `.env` file (less secure for public distribution): add the filename to assets by appending `.env` to `source.include_exts` (or `source.include_patterns = .env`). The existing `python-dotenv` call in your code should then load it if paths match. Remember: anyone extracting the APK can read it.
3. Bake stable defaults in `config/settings.py` and only override secrets via env vars in CI.

#### 4. Clean Build (Optional but Recommended First Time)
If you modified a previously attempted build environment:
```bash
buildozer android clean
```

#### 5. Build a Debug APK
```bash
buildozer -v android debug
```
The first invocation downloads the Android SDK, NDK, Gradle, and builds Python + dependencies (can exceed 30–40 minutes on a cold cache). Subsequent builds are much faster.

Result: `bin/SpotifyPlaylistCreator-0.1.0-debug.apk` (exact name may vary; check `bin/`).

#### 6. Deploy & Run on Device / Emulator
Enable USB debugging on the device and confirm it appears in `adb devices`.
```bash
buildozer android deploy run
```
Tail logs (Python + logcat combined):
```bash
buildozer android logcat
```
Filter only Python messages: `buildozer android logcat | grep python`.

#### 7. Common Debug Tips
* Force rebuild Python modules: `buildozer android debug deploy run logcat` (chained tasks are allowed).
* Stuck Gradle daemon: delete `.buildozer/android/platform/build-*` then rebuild.
* JNI / missing symbol errors: try upgrading Cython `python -m pip install --upgrade cython` and re-run.
* Out of memory during dexing: export `GRADLE_OPTS="-Xmx4g"` before build.

#### 8. Create a Signed Release (APK or AAB)
1. Generate a keystore (one-time):
   ```bash
   keytool -genkeypair -alias autoplaylist -keyalg RSA -keysize 2048 \
     -validity 10000 -keystore autoplaylist.keystore
   ```
2. Move keystore somewhere safe (outside repo) and reference it in `buildozer.spec`:
   ```ini
   # inside [app]
   android.release_keystore = /absolute/path/to/autoplaylist.keystore
   android.release_keystore_alias = autoplaylist
   android.release_keystore_pass = YOUR_KEYSTORE_PASSWORD
   android.release_keyalias_pass = YOUR_KEY_PASSWORD  # often same as keystore
   android.release_artifact = aab  # or apk
   ```
3. Build release:
   ```bash
   buildozer -v android release
   ```
4. Output is in `bin/` (use the `.aab` for Play Store). Keep the keystore + passwords backed up—losing them prevents future updates.

#### 9. Versioning & Upgrades
* Increment `version = 0.1.1` (string shown to users) and optionally set a manual `android.numeric_version = 2` if you need explicit control (monotonically increasing integer). If omitted, Buildozer auto-derives one.
* Clear caches for large dependency changes: `buildozer android clean`.

#### 10. Optional: Multi-Arch Considerations
Currently `android.archs = arm64-v8a, armeabi-v7a` ships two ABIs. If APK size is a concern and you only target modern devices, you can drop `armeabi-v7a`.

#### 11. Security Notes
* Avoid embedding secrets in the APK; treat anything shipped to users as public.
* Spotify redirect URIs on Android can be a custom scheme (e.g. `yourapp://callback`). Register it in your Spotify dashboard.

#### 12. Quick Checklist Before Release
| Check | Command / Location |
|-------|--------------------|
| Version bumped | `buildozer.spec` |
| Keystore configured | `buildozer.spec` |
| Uses INTERNET | `android.permissions` line |
| Icons set (adaptive) | `icon.adaptive_foreground/background` |
| Secrets provided via env | Export before build |
| Clean build done | `buildozer android clean` (if big changes) |

#### 13. Troubleshooting Reference
| Symptom | Likely Cause | Fix |
|---------|-------------|-----|
| "No build tools" error | Partial SDK download | `buildozer android clean` then rebuild; ensure stable network |
| SSL errors in requests | Missing cert bundle | Ensure `certifi` auto-included (it is via `requests`); if not, add to requirements |
| Black screen on launch | Kivy init failure | Check `buildozer android logcat` for texture / GL errors; verify orientation & window flags |
| Module not found (e.g. httpx) | Missing in `requirements` | Add to `requirements` and rebuild (`clean` if persistent) |
| Build gets stuck at "Installing/updating SDK" | Licenses not accepted | Set `android.accept_sdk_license = True` or interactively accept |

---
Once the release artifact is verified on at least one physical device (arm64), you can distribute it or upload to Play Console (AAB). For iterative dev cycles, you generally only need steps 2, 3 (if spec changes), and 5–6.

If you need CI automation later (GitHub Actions) we can add a workflow caching the `.buildozer` directory and keystore secrets—just ask.

